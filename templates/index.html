<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phantom Alert</title>

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Roboto:wght@400;700&display=swap" rel="stylesheet">

    <!-- PWA -->
    <link rel="manifest" href="/static/manifest.webmanifest">
    <meta name="theme-color" content="#0f172a">

    <style>
        body { margin: 0; font-family: 'Roboto', sans-serif; background-image: url('/static/bg_cyber_alt2.png'); background-size: cover; background-position: center; background-attachment: fixed; color: #E0E0E0; overflow: hidden; display: flex; justify-content: center; align-items: center; height: 100vh; }
        h1, h2, h3, .tab-button, button { font-family: 'Orbitron', sans-serif; }
        body.page2-active .save-button-alt, body.page2-active .save-message-alt { display: block; }

        /* Info panel */
        .info-panel h3 { color: #00f0ff; border-bottom: 1px solid #00f0ff; padding-bottom: 8px; margin-top: 25px; }
        .info-panel ul { padding-left: 20px; list-style: none; }
        .info-panel li { margin-bottom: 15px; }
        .info-panel .feature-title { font-weight: bold; color: #a0a0ff; }
        .info-panel .feature-desc { font-size: 0.9em; color: #c0c0c0; padding-left: 10px; margin-top: 5px; }
        .info-panel a { color: #ff3366; text-decoration: none; }
        .info-panel a:hover { text-decoration: underline; }

        /* Landing */
        #initial-home-page { display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100vh; width: 100vw; background-color: rgba(26, 26, 46, 0.8); position: fixed; top: 0; left: 0; z-index: 1000; transition: opacity 1s ease-out; }
        #initial-home-page.fade-out { opacity: 0; pointer-events: none; }
        .title-container { text-align: center; margin-bottom: 50px; opacity: 0; transition: opacity 1s ease-in; }
        .title { font-size: 4em; color: #00f0ff; text-shadow: 0 0 10px #00f0ff, 0 0 20px #00f0ff, 0 0 30px #00f0ff; animation: flicker 1.5s infinite alternate; }
        @keyframes flicker { 0%, 100% { opacity: 1; } 50% { opacity: 0.8; } }
        .start-button { background-color: #ff3366; color: white; border: none; padding: 15px 40px; font-size: 1.8em; border-radius: 5px; cursor: pointer; box-shadow: 0 0 15px #ff3366; transition: all 0.3s ease, opacity 1s ease-in; opacity: 0; }
        .start-button:hover { background-color: #e6004c; box-shadow: 0 0 25px #ff3366; transform: scale(1.05); }

        /* Main container */
        #main-ui-container { display: none; flex-direction: column; width: 95%; max-width: 1200px; height: 90vh; max-height: 850px; background-color: rgba(42, 42, 62, 0.85); backdrop-filter: blur(5px); border-radius: 10px; box-shadow: 0 0 20px rgba(0, 240, 255, 0.5); border: 1px solid #00f0ff; overflow: hidden; opacity: 0; transition: opacity 1s ease-in; }
        #main-ui-container.active { opacity: 1; display: flex; }
        #page-content-wrapper { flex-grow: 1; overflow-y: auto; }
        .page { display: none; padding: 20px; }
        .page.active { display: block; }

        /* Control bar */
        .control-bar { position: fixed; top: 15px; right: 15px; display: flex; flex-direction: column; align-items: stretch; z-index: 1001; }
        .control-button { padding: 5px 10px; font-size: 1.2em; margin-bottom: 8px; background-color: #4a4a5e; color: #e0e0e0; border: none; border-radius: 5px; cursor: pointer; transition: background-color 0.3s ease; text-align: center; width: 40px; height: 40px; display: flex; justify-content: center; align-items: center; }
        .control-button:hover { background-color: #5a5a6e; }
        .control-button.active { background-color: #00f0ff; color: #1a1a2e; font-weight: bold; }
        .save-button-alt, .save-message-alt { display: none; }
        .save-button-alt { background-color: #ff3366; color: white; font-weight: bold; margin-top: 15px; font-size: 12px; height: auto; width: auto; padding: 5px 10px; }
        .save-button-alt:hover { background-color: #e6004c; }
        .save-message-alt { color: #33ff33; font-size: 12px; text-align: right; margin-top: 5px; opacity: 0; transition: opacity 0.5s ease-out; font-weight: bold; height: 1em; }

        /* Panels */
        .content { display: flex; flex-direction: column; gap: 20px; }
        .panel-wrapper { display: flex; flex-wrap: wrap; gap: 20px; justify-content: center; align-items: flex-start; }
        .panel { background-color: rgba(43, 43, 64, 0.7); border: 1px solid #4a4a5e; border-radius: 8px; padding: 20px; box-shadow: 0 0 10px rgba(0, 240, 255, 0.2); flex: 1; min-width: 300px; box-sizing: border-box; }
        .sign-panel { max-width: calc(50% - 10px); }
        .settings-panel, .info-panel { max-width: 100%; }
        .log-content { height: 200px; overflow-y: auto; background-color: #1e1e2e; border: 1px solid #3a3a4e; padding: 10px; border-radius: 5px; font-size: 0.85em; color: #c0c0c0; margin-top: 10px; }
        h2, h3 { color: #00f0ff; border-bottom: 2px solid #00f0ff; padding-bottom: 5px; margin-top: 0; margin-bottom: 15px; }
        .sign-info p { margin: 4px 0; font-size: 0.9em; }
        .sign-info p span { font-weight: bold; color: #a0a0ff; }
        .signal-type { font-family: 'Orbitron', sans-serif; font-size: 1.6em; font-weight: bold; text-align: center; padding: 5px; margin: 8px 0; border-radius: 5px; background-color: #3a3a4e; color: #e0e0e0; transition: background-color 0.3s ease, color 0.3s ease; }
        .signal-type.buy { background-color: #00cc00; color: white; box-shadow: 0 0 10px #00cc00; }
        .signal-type.sell { background-color: #cc0000; color: white; box-shadow: 0 0 10px #cc0000; }
        .signal-chart { width: 100%; max-width: 600px; object-fit: contain; border: 1px solid #4a4a5e; border-radius: 5px; margin-top: 15px; background-color: #1e1e2e; }

        .setting-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 8px; color: #a0a0ff; font-weight: bold; }
        input[type="number"], select, input[type="radio"] + label { padding: 8px; border-radius: 5px; border: 1px solid #4a4a5e; background-color: #1e1e2e; color: #e0e0e0; font-size: 1em; width: 100%; box-sizing: border-box; }
        select { appearance: none; background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292%22%20height%3D%22292%22%3E%3Cpath%20fill%3D%22%23e0e0e0%22%20d%3D%22M287%2C106.5L146%2C247.5L5%2C106.5H287z%22%2F%3E%3C%2Fsvg%3E'); background-repeat: no-repeat; background-position: right 10px center; background-size: 12px; }
        .radio-group { display: flex; gap: 15px; margin-top: 10px; }
        input[type="radio"] { display: none; }
        input[type="radio"] + label { cursor: pointer; padding: 10px 20px; border: 2px solid #00f0ff; transition: all 0.3s ease; width: auto; text-align: center; }
        input[type="radio"]:checked + label { background-color: #00f0ff; color: #1a1a2e; box-shadow: 0 0 10px #00f0ff; }

        /* Tabs */
        .tab-container { flex-shrink: 0; display: flex; justify-content: space-around; background-color: rgba(30, 30, 46, 0.8); border-top: 1px solid #3a3a4e; padding: 10px 0; }
        .tab-button { background-color: transparent; color: #a0a0ff; border: none; padding: 10px 15px; font-size: 1em; cursor: pointer; transition: color 0.3s ease, background-color 0.3s ease; flex-grow: 1; text-align: center; border-radius: 5px; margin: 0 5px; }
        .tab-button:hover { color: #00f0ff; background-color: #3a3a4e; }
        .tab-button.active { color: #1a1a2e; background-color: #00f0ff; font-weight: bold; }

        /* Analysis */
        #analysisResultChart { width: 100%; max-width: 800px; margin-top: 20px; border: 1px solid #4a4a5e; border-radius: 5px; background-color: #1e1e2e;}
        #analysisResultPredictions { margin-top: 20px; background-color: #1e1e2e; padding: 15px; border-radius: 5px; white-space: pre-wrap; font-family: monospace; }
        .analysis-controls { display: flex; gap: 10px; align-items: center; }
        .analysis-controls button { height: 40px; margin-top: 25px; cursor: pointer; background-color: #ff3366; color: white; border: none; border-radius: 5px; padding: 0 20px; }
        .analysis-controls button:disabled { background-color: #555; cursor: not-allowed; }

        @media (max-width: 768px) {
            #main-ui-container { height: 95vh; max-height: none; }
            .title { font-size: 2.5em; }
            .start-button { font-size: 1.4em; padding: 12px 30px; }
            .panel-wrapper, .log-area-container { flex-direction: column; align-items: center; }
            .panel, .log-area { max-width: 100%; }
            .signal-chart { height: 250px; }
            /* èƒŒæ™¯å›ºå®šã¯ãƒ¢ãƒã‚¤ãƒ«ã§é‡ã„ã®ã§è§£é™¤ */
            body { background-attachment: scroll; }
        }
    </style>
</head>
<body>
    <!-- Landing -->
    <div id="initial-home-page" aria-label="Initial screen">
        <div class="title-container"><h1 class="title">Phantom Alert</h1></div>
        <button class="start-button" id="startButton" aria-label="Start">START</button>
    </div>

    <!-- Controls -->
    <div class="control-bar" aria-label="Global controls">
        <button class="control-button" id="bgmToggle" title="BGM ON/OFF" aria-label="Toggle BGM">ğŸµ</button>
        <button class="control-button" id="langToggle" title="è¨€èªåˆ‡ã‚Šæ›¿ãˆ / Language" aria-label="Toggle language">ğŸŒ</button>
        <button class="control-button save-button-alt" id="saveSettings" data-lang-key="save" aria-label="Save settings">ä¿å­˜</button>
        <p class="save-message-alt" id="saveMessage" role="status" aria-live="polite"></p>
    </div>

    <!-- Main UI -->
    <div id="main-ui-container" role="main" aria-label="Main UI">
        <div id="page-content-wrapper">
            <!-- Page1 -->
            <div id="page1" class="page active" aria-labelledby="tab-sign">
                <div class="content">
                    <div class="panel-wrapper">
                        <div class="panel sign-panel">
                            <h2 data-lang-key="latestSignal">æœ€æ–°ã‚·ã‚°ãƒŠãƒ«</h2>
                            <div class="sign-info">
                                <p><span data-lang-key="symbol">é€šè²¨ãƒšã‚¢</span>: <span id="signalSymbol">N/A</span></p>
                                <p><span data-lang-key="timeframe">æ™‚é–“è¶³</span>: <span id="signalTimeframe">N/A</span></p>
                                <p><span data-lang-key="currentPrice">ç¾åœ¨ä¾¡æ ¼</span>: <span id="currentPrice">N/A</span></p>
                                <p><span data-lang-key="description">èª¬æ˜</span>: <span id="signalDesc"></span></p>
                                <div class="signal-type" id="signalType">NONE</div>
                                <p><span data-lang-key="entry">ã‚¨ãƒ³ãƒˆãƒªãƒ¼</span>: <span id="signalEntry">N/A</span></p>
                                <p><span data-lang-key="tp">åˆ©ç¢º</span>: <span id="signalTP">N/A</span></p>
                                <p><span data-lang-key="sl">æåˆ‡</span>: <span id="signalSL">N/A</span></p>
                            </div>
                            <img src="/static/default_chart.png" alt="Chart" class="signal-chart" id="signalChart">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Page2 -->
            <div id="page2" class="page" aria-labelledby="tab-settings">
                <div class="content">
                    <div class="panel-wrapper">
                        <div class="panel settings-panel">
                            <h2 data-lang-key="settings">è¨­å®š</h2>

                            <div class="setting-group">
                                <label data-lang-key="tradingMode">å–å¼•ãƒ¢ãƒ¼ãƒ‰</label>
                                <div class="radio-group" role="group" aria-label="Trading mode">
                                    <input type="radio" id="modeScalp" name="mode" value="scalp">
                                    <label for="modeScalp" data-lang-key="scalp">ã‚¹ã‚­ãƒ£ãƒ«ãƒ”ãƒ³ã‚°</label>

                                    <input type="radio" id="modeDaytrade" name="mode" value="daytrade">
                                    <label for="modeDaytrade" data-lang-key="daytrade">ãƒ‡ã‚¤ãƒˆãƒ¬ãƒ¼ãƒ‰</label>
                                </div>
                            </div>

                            <div class="setting-group">
                                <label for="lotSize" data-lang-key="lotSize">ãƒ­ãƒƒãƒˆæ•°</label>
                                <input type="number" id="lotSize" name="lotSize" step="0.01" min="0.01">
                            </div>

                            <div class="setting-group">
                                <label data-lang-key="autoTrading">è‡ªå‹•å£²è²·ãƒ¢ãƒ¼ãƒ‰</label>
                                <div class="radio-group" role="group" aria-label="Auto trading">
                                    <input type="radio" id="autoTradingOff" name="autotrade" value="false">
                                    <label for="autoTradingOff" data-lang-key="autoTradingOff">ç›£è¦–ã®ã¿</label>

                                    <input type="radio" id="autoTradingOn" name="autotrade" value="true">
                                    <label for="autoTradingOn" data-lang-key="autoTradingOn">å®Ÿè¡Œã™ã‚‹</label>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>
            </div>

            <!-- Page3 -->
            <div id="page3" class="page" aria-labelledby="tab-logs">
                <div class="content">
                    <div class="setting-group">
                        <label for="logSymbolSelect" data-lang-key="logSymbolSelect">è¡¨ç¤ºã™ã‚‹ãƒ­ã‚°ã‚’é¸æŠ</label>
                        <select id="logSymbolSelect"></select>
                    </div>
                    <div id="singleLogContent" class="log-content"></div>
                </div>
            </div>

            <!-- Page4 -->
            <div id="page4" class="page" aria-labelledby="tab-info">
                <div class="content">
                    <div class="panel info-panel" style="max-width: 100%;">
                        <h2 data-lang-key="appName">Phantom Alertï¼šã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³æ¦‚è¦</h2>
                        <p data-lang-key="appDesc">ã€ŒPhantom Alertã€ã¯ã€é«˜æ©Ÿèƒ½ãªå–å¼•ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã§ã‚ã‚‹MT5ï¼ˆMetaTrader 5ï¼‰ã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ä¾¡æ ¼ãƒ‡ãƒ¼ã‚¿ã¨é€£æºã—ã¦å‹•ä½œã™ã‚‹ã€è‡ªå‹•ã‚·ã‚°ãƒŠãƒ«ç”Ÿæˆã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§ã™ã€‚å†…éƒ¨ã«çµ„ã¿è¾¼ã¾ã‚ŒãŸå–å¼•ãƒ­ã‚¸ãƒƒã‚¯ã«åŸºã¥ãã€å£²è²·ã®ãƒãƒ£ãƒ³ã‚¹ã‚’24æ™‚é–“ç›£è¦–ã—ã¾ã™ã€‚ã‚·ã‚°ãƒŠãƒ«ãŒæ¤œçŸ¥ã•ã‚Œã‚‹ã¨ã€LINEã‚„Gmailã¸ã®é€šçŸ¥ã€ãã—ã¦ã“ã®Web UIï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ï¼‰ã‚’é€šã˜ã¦ã€åˆ©ç”¨è€…ã«æƒ…å ±ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§æä¾›ã™ã‚‹ã“ã¨ã‚’ç›®çš„ã¨ã—ã¦ã„ã¾ã™ã€‚</p>

                        <h3 data-lang-key="features">ç‰¹å¾´</h3>
                        <ul>
                            <li>
                                <span class="feature-title" data-lang-key="feature1_title">â€¢ ãƒãƒ«ãƒé€šè²¨ãƒšã‚¢ãƒ»ãƒãƒ«ãƒæ™‚é–“è¶³å¯¾å¿œ</span>
                                <p class="feature-desc" data-lang-key="feature1_desc">USDJPYï¼ˆãƒ‰ãƒ«å††ï¼‰ã€EURUSDï¼ˆãƒ¦ãƒ¼ãƒ­ãƒ‰ãƒ«ï¼‰ã€GOLDï¼ˆã‚´ãƒ¼ãƒ«ãƒ‰ï¼‰ã€BTCUSDï¼ˆãƒ“ãƒƒãƒˆã‚³ã‚¤ãƒ³ï¼‰ãªã©ã€è¤‡æ•°ã®é‡‘èå•†å“ã‚’åŒæ™‚ã«ç›£è¦–ã§ãã¾ã™ã€‚ã•ã‚‰ã«ã€M1ï¼ˆ1åˆ†è¶³ï¼‰ã®ã‚ˆã†ãªçŸ­æœŸè¶³ã‹ã‚‰D1ï¼ˆæ—¥è¶³ï¼‰ã¨ã„ã£ãŸé•·æœŸè¶³ã¾ã§ã€è¤‡æ•°ã®æ™‚é–“è»¸ã§åˆ†æã‚’è¡Œã„ã€å¤šæ§˜ãªå–å¼•ã‚¹ã‚¿ã‚¤ãƒ«ã«å¯¾å¿œã—ã¾ã™ã€‚</p>
                            </li>
                            <li>
                                <span class="feature-title" data-lang-key="feature2_title">â€¢ æœ€é©åŒ–ã•ã‚ŒãŸå–å¼•ãƒ­ã‚¸ãƒƒã‚¯</span>
                                <p class="feature-desc" data-lang-key="feature2_desc">å˜ä¸€ã®ãƒ†ã‚¯ãƒ‹ã‚«ãƒ«æŒ‡æ¨™ã«é ¼ã‚‹ã®ã§ã¯ãªãã€RSIã€MACDã€ã‚¹ãƒˆã‚­ãƒ£ã‚¹ãƒ†ã‚£ã‚¯ã‚¹ã€ãƒœãƒªãƒ³ã‚¸ãƒ£ãƒ¼ãƒãƒ³ãƒ‰ã€è¤‡æ•°ã®æŒ‡æ•°ç§»å‹•å¹³å‡ï¼ˆEMAï¼‰ãªã©ã‚’çµ„ã¿åˆã‚ã›ãŸã€è¤‡åˆçš„ãªåˆ†æã‚’è¡Œã„ã¾ã™ã€‚é•·æœŸã®ãƒˆãƒ¬ãƒ³ãƒ‰ã«é †å¼µã‚Šã™ã‚‹ã€Œãƒˆãƒ¬ãƒ³ãƒ‰ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã€æ©Ÿèƒ½ã‚‚æ­è¼‰ã—ã€ä¿¡é ¼æ€§ã®é«˜ã„ã‚·ã‚°ãƒŠãƒ«ç”Ÿæˆã‚’ç›®æŒ‡ã—ã¦ã„ã¾ã™ã€‚</p>
                            </li>
                            <li>
                                <span class="feature-title" data-lang-key="feature3_title">â€¢ LINE/Gmailé€šçŸ¥æ©Ÿèƒ½</span>
                                <p class="feature-desc" data-lang-key="feature3_desc">ã‚·ã‚°ãƒŠãƒ«ç™ºç”Ÿæ™‚ã«ã€ã”æŒ‡å®šã®LINEã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚„Gmailã‚¢ãƒ‰ãƒ¬ã‚¹ã¸å³åº§ã«é€šçŸ¥ã‚’é€ä¿¡ã—ã¾ã™ã€‚é€šçŸ¥ã«ã¯ã€ã‚·ã‚°ãƒŠãƒ«ã®æ ¹æ‹ ã¨ãªã£ãŸãƒ†ã‚¯ãƒ‹ã‚«ãƒ«æƒ…å ±ã«åŠ ãˆã€ãã®æ™‚ç‚¹ã§ã®ãƒãƒ£ãƒ¼ãƒˆç”»åƒã‚’æ·»ä»˜ã™ã‚‹ã“ã¨ãŒã§ãã€å¤–å‡ºå…ˆã§ã‚‚è¦–è¦šçš„ã«çŠ¶æ³ã‚’æŠŠæ¡ã§ãã¾ã™ã€‚</p>
                            </li>
                            <li>
                                <span class="feature-title" data-lang-key="feature4_title">â€¢ Web UIã§ã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç›£è¦–ã¨è¨­å®š</span>
                                <p class="feature-desc" data-lang-key="feature4_desc">ç¾åœ¨ã”è¦§ã«ãªã£ã¦ã„ã‚‹ã“ã®Webç”»é¢ã‚’é€šã˜ã¦ã€æœ€æ–°ã®ã‚·ã‚°ãƒŠãƒ«ã€éå»ã®ãƒ­ã‚°ãªã©ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§ç¢ºèªã§ãã¾ã™ã€‚ã€Œè¨­å®šã€ã‚¿ãƒ–ã‹ã‚‰ã¯ã€å–å¼•ãƒ¢ãƒ¼ãƒ‰ï¼ˆã‚¹ã‚­ãƒ£ãƒ«ãƒ”ãƒ³ã‚°/ãƒ‡ã‚¤ãƒˆãƒ¬ãƒ¼ãƒ‰ï¼‰ã®åˆ‡ã‚Šæ›¿ãˆã‚„ã€è‡ªå‹•å£²è²·ã®æœ‰åŠ¹åŒ–/ç„¡åŠ¹åŒ–ãªã©ã€ãƒœãƒƒãƒˆã®å‹•ä½œã‚’ç›´æ¥ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã™ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™ã€‚</p>
                            </li>
                        </ul>

                        <h3 data-lang-key="disclaimer">å…è²¬äº‹é …</h3>
                        <p data-lang-key="disclaimerText">ã€ŒPhantom Alertã€ãŒæä¾›ã™ã‚‹å£²è²·ã‚·ã‚°ãƒŠãƒ«ã¯ã€ã‚ãã¾ã§éå»ã®ä¾¡æ ¼ãƒ‡ãƒ¼ã‚¿ã«åŸºã¥ã„ãŸãƒ†ã‚¯ãƒ‹ã‚«ãƒ«åˆ†æã®çµæœã§ã‚ã‚Šã€å°†æ¥ã®å¸‚å ´ã®å‹•ãã‚’ä¿è¨¼ã™ã‚‹ã‚‚ã®ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚å¸‚å ´ã«ã¯äºˆæ¸¬ä¸å¯èƒ½ãªå¤šãã®è¦å› ãŒå­˜åœ¨ã—ã¾ã™ã€‚ã“ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’åˆ©ç”¨ã—ãŸæŠ•è³‡ã«é–¢ã™ã‚‹æœ€çµ‚çš„ãªåˆ¤æ–­ã¯ã€å…¨ã¦åˆ©ç”¨è€…ã”è‡ªèº«ã®è²¬ä»»ã«ãŠã„ã¦è¡Œã£ã¦ãã ã•ã„ã€‚</p>

                        <h3 data-lang-key="contact">ãŠå•ã„åˆã‚ã›</h3>
                        <p data-lang-key="contactText">ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«é–¢ã™ã‚‹ã”ä¸æ˜ãªç‚¹ã‚„ã€æ©Ÿèƒ½è¿½åŠ ãªã©ã®ã”è¦æœ›ãŒã‚ã‚Šã¾ã—ãŸã‚‰ã€ä»¥ä¸‹ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¾ã§ã”é€£çµ¡ãã ã•ã„ã€‚ <a href="mailto:support@phantom-alert.com">support@phantom-alert.com</a></p>
                    </div>
                </div>
            </div>

            <!-- Page5 -->
            <div id="page5" class="page" aria-labelledby="tab-analysis">
                <div class="panel" style="max-width: 100%;">
                    <h2 data-lang-key="analysisTab">æ‰‹å‹•ãƒ©ã‚¤ãƒ³åˆ†æ</h2>
                    <div class="setting-group analysis-controls">
                        <div>
                            <label for="analysisSymbol">é€šè²¨ãƒšã‚¢</label>
                            <select id="analysisSymbol"></select>
                        </div>
                        <div>
                            <label for="analysisTimeframe">æ™‚é–“è¶³</label>
                            <select id="analysisTimeframe">
                                <option value="M5">5åˆ†è¶³</option>
                                <option value="M15">15åˆ†è¶³</option>
                                <option value="H1" selected>1æ™‚é–“è¶³</option>
                                <option value="D1">æ—¥è¶³</option>
                            </select>
                        </div>
                        <button id="runAnalysisBtn">åˆ†æå®Ÿè¡Œ</button>
                    </div>
                    <div id="analysisResultArea">
                        <p id="analysisStatus">åˆ†æã—ãŸã„é€šè²¨ãƒšã‚¢ã¨æ™‚é–“è¶³ã‚’é¸ã‚“ã§ã€ã€Œåˆ†æå®Ÿè¡Œã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚</p>
                        <pre id="analysisResultPredictions"></pre>
                        <img id="analysisResultChart" src="" style="display: none;" alt="Analysis chart"/>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="tab-container" role="tablist" aria-label="Primary tabs">
            <button class="tab-button active" id="tab-sign" role="tab" aria-selected="true" onclick="showPage('page1', this)" data-lang-key="signPanelTab">ã‚µã‚¤ãƒ³ãƒ‘ãƒãƒ«</button>
            <button class="tab-button" id="tab-settings" role="tab" aria-selected="false" onclick="showPage('page2', this)" data-lang-key="settingsTab">è¨­å®š</button>
            <button class="tab-button" id="tab-logs" role="tab" aria-selected="false" onclick="showPage('page3', this)" data-lang-key="logsTab">ãƒ­ã‚°</button>
            <button class="tab-button" id="tab-info" role="tab" aria-selected="false" onclick="showPage('page4', this)" data-lang-key="infoTab">æƒ…å ±</button>
            <button class="tab-button" id="tab-analysis" role="tab" aria-selected="false" onclick="showPage('page5', this)" data-lang-key="analysisTab">åˆ†æãƒ‘ãƒãƒ«</button>
        </div>
    </div>

    <!-- Audio -->
    <audio id="bgm" src="/static/bgm.mp3" loop></audio>
    <audio id="clickSound" src="/static/sound_scalp.mp3"></audio>
    <audio id="buySound" src="/static/buy.mp3"></audio>
    <audio id="sellSound" src="/static/sell.mp3"></audio>

    <script>
        // --- Global Variables & Elements ---
        const bgm = document.getElementById('bgm');
        const clickSound = document.getElementById('clickSound');
        const initialHomePage = document.getElementById('initial-home-page');
        const mainUiContainer = document.getElementById('main-ui-container');
        const bgmToggleButton = document.getElementById('bgmToggle');
        const langToggleButton = document.getElementById('langToggle');
        const saveSettingsButton = document.getElementById('saveSettings');

        let isBgmPlaying = false;
        let currentLang = 'ja';
        let logUpdateInterval;

        // AbortControllers for fetch cancellation
        let signalsAbortController = null;
        let logsAbortController = null;
        let analysisAbortController = null;

        // i18n dictionary
        const translations = {
            ja: {
                save: "ä¿å­˜",
                signPanelTab: "ã‚µã‚¤ãƒ³ãƒ‘ãƒãƒ«",
                settingsTab: "è¨­å®š",
                logsTab: "ãƒ­ã‚°",
                infoTab: "æƒ…å ±",
                analysisTab: "åˆ†æãƒ‘ãƒãƒ«",
                logSymbolSelect: "è¡¨ç¤ºã™ã‚‹ãƒ­ã‚°ã‚’é¸æŠ",
                latestSignal: "æœ€æ–°ã‚·ã‚°ãƒŠãƒ«",
                symbol: "é€šè²¨ãƒšã‚¢",
                timeframe: "æ™‚é–“è¶³",
                currentPrice: "ç¾åœ¨ä¾¡æ ¼",
                description: "èª¬æ˜",
                entry: "ã‚¨ãƒ³ãƒˆãƒªãƒ¼",
                tp: "åˆ©ç¢º",
                sl: "æåˆ‡",
                settings: "è¨­å®š",
                tradingMode: "å–å¼•ãƒ¢ãƒ¼ãƒ‰",
                scalp: "ã‚¹ã‚­ãƒ£ãƒ«ãƒ”ãƒ³ã‚°",
                daytrade: "ãƒ‡ã‚¤ãƒˆãƒ¬ãƒ¼ãƒ‰",
                lotSize: "ãƒ­ãƒƒãƒˆæ•°",
                autoTrading: "è‡ªå‹•å£²è²·ãƒ¢ãƒ¼ãƒ‰",
                autoTradingOff: "ç›£è¦–ã®ã¿",
                autoTradingOn: "å®Ÿè¡Œã™ã‚‹",
                appName: "Phantom Alertï¼šã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³æ¦‚è¦",
                appDesc: "ã€ŒPhantom Alertã€ã¯ã€é«˜æ©Ÿèƒ½ãªå–å¼•ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã§ã‚ã‚‹MT5ï¼ˆMetaTrader 5ï¼‰ã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ä¾¡æ ¼ãƒ‡ãƒ¼ã‚¿ã¨é€£æºã—ã¦å‹•ä½œã™ã‚‹ã€è‡ªå‹•ã‚·ã‚°ãƒŠãƒ«ç”Ÿæˆã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§ã™ã€‚å†…éƒ¨ã«çµ„ã¿è¾¼ã¾ã‚ŒãŸå–å¼•ãƒ­ã‚¸ãƒƒã‚¯ã«åŸºã¥ãã€å£²è²·ã®ãƒãƒ£ãƒ³ã‚¹ã‚’24æ™‚é–“ç›£è¦–ã—ã¾ã™ã€‚ã‚·ã‚°ãƒŠãƒ«ãŒæ¤œçŸ¥ã•ã‚Œã‚‹ã¨ã€LINEã‚„Gmailã¸ã®é€šçŸ¥ã€ãã—ã¦ã“ã®Web UIï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ï¼‰ã‚’é€šã˜ã¦ã€åˆ©ç”¨è€…ã«æƒ…å ±ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§æä¾›ã™ã‚‹ã“ã¨ã‚’ç›®çš„ã¨ã—ã¦ã„ã¾ã™ã€‚",
                features: "ç‰¹å¾´",
                feature1_title: "â€¢ ãƒãƒ«ãƒé€šè²¨ãƒšã‚¢ãƒ»ãƒãƒ«ãƒæ™‚é–“è¶³å¯¾å¿œ",
                feature1_desc: "USDJPYï¼ˆãƒ‰ãƒ«å††ï¼‰ã€EURUSDï¼ˆãƒ¦ãƒ¼ãƒ­ãƒ‰ãƒ«ï¼‰ã€GOLDï¼ˆã‚´ãƒ¼ãƒ«ãƒ‰ï¼‰ã€BTCUSDï¼ˆãƒ“ãƒƒãƒˆã‚³ã‚¤ãƒ³ï¼‰ãªã©ã€è¤‡æ•°ã®é‡‘èå•†å“ã‚’åŒæ™‚ã«ç›£è¦–ã§ãã¾ã™ã€‚ã•ã‚‰ã«ã€M1ï¼ˆ1åˆ†è¶³ï¼‰ã®ã‚ˆã†ãªçŸ­æœŸè¶³ã‹ã‚‰D1ï¼ˆæ—¥è¶³ï¼‰ã¨ã„ã£ãŸé•·æœŸè¶³ã¾ã§ã€è¤‡æ•°ã®æ™‚é–“è»¸ã§åˆ†æã‚’è¡Œã„ã€å¤šæ§˜ãªå–å¼•ã‚¹ã‚¿ã‚¤ãƒ«ã«å¯¾å¿œã—ã¾ã™ã€‚",
                feature2_title: "â€¢ æœ€é©åŒ–ã•ã‚ŒãŸå–å¼•ãƒ­ã‚¸ãƒƒã‚¯",
                feature2_desc: "å˜ä¸€ã®ãƒ†ã‚¯ãƒ‹ã‚«ãƒ«æŒ‡æ¨™ã«é ¼ã‚‹ã®ã§ã¯ãªãã€RSIã€MACDã€ã‚¹ãƒˆã‚­ãƒ£ã‚¹ãƒ†ã‚£ã‚¯ã‚¹ã€ãƒœãƒªãƒ³ã‚¸ãƒ£ãƒ¼ãƒãƒ³ãƒ‰ã€è¤‡æ•°ã®æŒ‡æ•°ç§»å‹•å¹³å‡ï¼ˆEMAï¼‰ãªã©ã‚’çµ„ã¿åˆã‚ã›ãŸã€è¤‡åˆçš„ãªåˆ†æã‚’è¡Œã„ã¾ã™ã€‚é•·æœŸã®ãƒˆãƒ¬ãƒ³ãƒ‰ã«é †å¼µã‚Šã™ã‚‹ã€Œãƒˆãƒ¬ãƒ³ãƒ‰ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã€æ©Ÿèƒ½ã‚‚æ­è¼‰ã—ã€ä¿¡é ¼æ€§ã®é«˜ã„ã‚·ã‚°ãƒŠãƒ«ç”Ÿæˆã‚’ç›®æŒ‡ã—ã¦ã„ã¾ã™ã€‚",
                feature3_title: "â€¢ LINE/Gmailé€šçŸ¥æ©Ÿèƒ½",
                feature3_desc: "ã‚·ã‚°ãƒŠãƒ«ç™ºç”Ÿæ™‚ã«ã€ã”æŒ‡å®šã®LINEã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚„Gmailã‚¢ãƒ‰ãƒ¬ã‚¹ã¸å³åº§ã«é€šçŸ¥ã‚’é€ä¿¡ã—ã¾ã™ã€‚é€šçŸ¥ã«ã¯ã€ã‚·ã‚°ãƒŠãƒ«ã®æ ¹æ‹ ã¨ãªã£ãŸãƒ†ã‚¯ãƒ‹ã‚«ãƒ«æƒ…å ±ã«åŠ ãˆã€ãã®æ™‚ç‚¹ã§ã®ãƒãƒ£ãƒ¼ãƒˆç”»åƒã‚’æ·»ä»˜ã™ã‚‹ã“ã¨ãŒã§ãã€å¤–å‡ºå…ˆã§ã‚‚è¦–è¦šçš„ã«çŠ¶æ³ã‚’æŠŠæ¡ã§ãã¾ã™ã€‚",
                feature4_title: "â€¢ Web UIã§ã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç›£è¦–ã¨è¨­å®š",
                feature4_desc: "ç¾åœ¨ã”è¦§ã«ãªã£ã¦ã„ã‚‹ã“ã®Webç”»é¢ã‚’é€šã˜ã¦ã€æœ€æ–°ã®ã‚·ã‚°ãƒŠãƒ«ã€éå»ã®ãƒ­ã‚°ãªã©ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§ç¢ºèªã§ãã¾ã™ã€‚ã€Œè¨­å®šã€ã‚¿ãƒ–ã‹ã‚‰ã¯ã€å–å¼•ãƒ¢ãƒ¼ãƒ‰ï¼ˆã‚¹ã‚­ãƒ£ãƒ«ãƒ”ãƒ³ã‚°/ãƒ‡ã‚¤ãƒˆãƒ¬ãƒ¼ãƒ‰ï¼‰ã®åˆ‡ã‚Šæ›¿ãˆã‚„ã€è‡ªå‹•å£²è²·ã®æœ‰åŠ¹åŒ–/ç„¡åŠ¹åŒ–ãªã©ã€ãƒœãƒƒãƒˆã®å‹•ä½œã‚’ç›´æ¥ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã™ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™ã€‚",
                disclaimer: "å…è²¬äº‹é …",
                disclaimerText: "ã€ŒPhantom Alertã€ãŒæä¾›ã™ã‚‹å£²è²·ã‚·ã‚°ãƒŠãƒ«ã¯ã€ã‚ãã¾ã§éå»ã®ä¾¡æ ¼ãƒ‡ãƒ¼ã‚¿ã«åŸºã¥ã„ãŸãƒ†ã‚¯ãƒ‹ã‚«ãƒ«åˆ†æã®çµæœã§ã‚ã‚Šã€å°†æ¥ã®å¸‚å ´ã®å‹•ãã‚’ä¿è¨¼ã™ã‚‹ã‚‚ã®ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚å¸‚å ´ã«ã¯äºˆæ¸¬ä¸å¯èƒ½ãªå¤šãã®è¦å› ãŒå­˜åœ¨ã—ã¾ã™ã€‚ã“ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’åˆ©ç”¨ã—ãŸæŠ•è³‡ã«é–¢ã™ã‚‹æœ€çµ‚çš„ãªåˆ¤æ–­ã¯ã€å…¨ã¦åˆ©ç”¨è€…ã”è‡ªèº«ã®è²¬ä»»ã«ãŠã„ã¦è¡Œã£ã¦ãã ã•ã„ã€‚",
                contact: "ãŠå•ã„åˆã‚ã›",
                contactText: "ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«é–¢ã™ã‚‹ã”ä¸æ˜ãªç‚¹ã‚„ã€æ©Ÿèƒ½è¿½åŠ ãªã©ã®ã”è¦æœ›ãŒã‚ã‚Šã¾ã—ãŸã‚‰ã€ä»¥ä¸‹ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¾ã§ã”é€£çµ¡ãã ã•ã„ã€‚"
            },
            en: {
                save: "Save",
                signPanelTab: "Signal Panel",
                settingsTab: "Settings",
                logsTab: "Logs",
                infoTab: "Info",
                analysisTab: "Analysis",
                logSymbolSelect: "Select log to display",
                latestSignal: "Latest Signal",
                symbol: "Symbol",
                timeframe: "Timeframe",
                currentPrice: "Current Price",
                description: "Description",
                entry: "Entry",
                tp: "Take Profit",
                sl: "Stop Loss",
                settings: "Settings",
                tradingMode: "Trading Mode",
                scalp: "Scalping",
                daytrade: "Day Trading",
                lotSize: "Lot Size",
                autoTrading: "Auto Trading Mode",
                autoTradingOff: "Monitor Only",
                autoTradingOn: "Execute",
                appName: "Phantom Alert: Application Overview",
                appDesc: "Phantom Alert is a real-time signal-generation application that works with MetaTrader 5 (MT5). It continuously watches the market based on internal trading logic and notifies you via LINE, Gmail, and this web UI when opportunities arise.",
                features: "Features",
                feature1_title: "â€¢ Multi-symbol & Multi-timeframe",
                feature1_desc: "Monitor multiple instruments like USDJPY, EURUSD, GOLD, and BTCUSD across timeframes from M1 to D1, supporting various trading styles.",
                feature2_title: "â€¢ Optimized Trading Logic",
                feature2_desc: "Combines RSI, MACD, Stochastic, Bollinger Bands, and multiple EMAs with a long-trend filter to produce more reliable signals.",
                feature3_title: "â€¢ LINE / Gmail Notifications",
                feature3_desc: "Sends instant notifications with technical context and chart images so you can confirm signals on the go.",
                feature4_title: "â€¢ Real-time Web UI",
                feature4_desc: "View the latest signals and logs in real time and control the botâ€™s behavior (mode, auto-trading) from the Settings tab.",
                disclaimer: "Disclaimer",
                disclaimerText: "Signals are based on historical data and do not guarantee future performance. Final investment decisions are your sole responsibility.",
                contact: "Contact",
                contactText: "For inquiries or feature requests, contact: "
            }
        };

        function updateTexts(lang) {
            document.querySelectorAll('[data-lang-key]').forEach(element => {
                const key = element.getAttribute('data-lang-key');
                if (translations[lang] && translations[lang][key]) {
                    element.textContent = translations[lang][key];
                }
            });
        }

        function setImageSrc(imgElem, url) {
            if (!imgElem) return;
            const u = (url || '').trim();
            if (!u) {
                imgElem.src = '/static/default_chart.png';
                return;
            }
            // Allow absolute, data URL, or relative
            let finalUrl = u;
            if (!(u.startsWith('http://') || u.startsWith('https://') || u.startsWith('data:'))) {
                finalUrl = u.startsWith('/') ? u : '/' + u;
            }
            // Add timestamp param if none present
            if (!finalUrl.includes('?')) finalUrl += `?t=${Date.now()}`;
            imgElem.src = finalUrl;
        }

        document.addEventListener('DOMContentLoaded', () => {
            // Intro fade-in
            setTimeout(() => {
                const title = document.querySelector('.title-container');
                const startBtn = document.getElementById('startButton');
                if (title) title.style.opacity = 1;
                if (startBtn) startBtn.style.opacity = 1;
            }, 500);

            // START
            document.getElementById('startButton').addEventListener('click', () => {
                clickSound.play().catch(()=>{});
                initialHomePage.classList.add('fade-out');
                setTimeout(() => {
                    initialHomePage.style.display = 'none';
                    mainUiContainer.style.display = 'flex';
                    setTimeout(() => mainUiContainer.classList.add('active'), 10);
                    bgm.play().then(()=>{ isBgmPlaying = true; bgmToggleButton.classList.add('active'); }).catch(()=>{});
                    document.documentElement.lang = currentLang;
                    updateTexts(currentLang);
                    setupLogSelector();
                    updateSignalData();
                }, 1000);
            });

            // BGM toggle
            bgmToggleButton.addEventListener('click', () => {
                clickSound.play().catch(()=>{});
                isBgmPlaying = !isBgmPlaying;
                if (isBgmPlaying) { bgm.play().catch(()=>{}); } else { bgm.pause(); }
                bgmToggleButton.classList.toggle('active', isBgmPlaying);
            });

            // Language toggle
            langToggleButton.addEventListener('click', () => {
                clickSound.play().catch(()=>{});
                currentLang = (currentLang === 'ja') ? 'en' : 'ja';
                document.documentElement.lang = currentLang;
                updateTexts(currentLang);
            });

            // Save settings (with server + localStorage fallback)
            saveSettingsButton.addEventListener('click', async () => {
                clickSound.play().catch(()=>{});
                const payload = {
                    mode: (document.querySelector('input[name="mode"]:checked') || {}).value || 'scalp',
                    auto_trading: (document.querySelector('input[name="autotrade"]:checked') || {}).value === 'true',
                    lot_size: parseFloat(document.getElementById('lotSize').value) || 0.01
                };
                const saveMessage = document.getElementById('saveMessage');
                const okText = currentLang === 'en' ? 'Settings saved!' : 'è¨­å®šãŒä¿å­˜ã•ã‚Œã¾ã—ãŸï¼';
                const ngText = currentLang === 'en' ? 'Failed to save settings. Saved locally.' : 'è¨­å®šã®ä¿å­˜ã«å¤±æ•—ã€‚ãƒ­ãƒ¼ã‚«ãƒ«ã«ä¿å­˜ã—ã¾ã—ãŸã€‚';

                try {
                    const response = await fetch('/update_settings', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(payload)
                    });
                    if (!response.ok) throw new Error('server error');
                    const data = await response.json();
                    if (data.status === 'success') {
                        localStorage.setItem('phantom_settings', JSON.stringify(payload));
                        saveMessage.textContent = okText;
                    } else {
                        localStorage.setItem('phantom_settings', JSON.stringify(payload));
                        saveMessage.textContent = ngText;
                    }
                } catch (e) {
                    localStorage.setItem('phantom_settings', JSON.stringify(payload));
                    saveMessage.textContent = ngText;
                }
                saveMessage.style.opacity = 1;
                setTimeout(() => { saveMessage.style.opacity = 0; }, 2000);
            });

            // Load settings (server then localStorage fallback)
            (async () => {
                try {
                    const r = await fetch('/get_settings');
                    if (!r.ok) throw new Error('server error');
                    const s = await r.json();
                    document.getElementById(s.mode === 'daytrade' ? 'modeDaytrade' : 'modeScalp').checked = true;
                    document.getElementById(s.auto_trading ? 'autoTradingOn' : 'autoTradingOff').checked = true;
                    document.getElementById('lotSize').value = s.lot_size || 0.01;
                    localStorage.setItem('phantom_settings', JSON.stringify(s));
                } catch {
                    const local = localStorage.getItem('phantom_settings');
                    if (local) {
                        const s = JSON.parse(local);
                        document.getElementById(s.mode === 'daytrade' ? 'modeDaytrade' : 'modeScalp').checked = true;
                        document.getElementById(s.auto_trading ? 'autoTradingOn' : 'autoTradingOff').checked = true;
                        document.getElementById('lotSize').value = s.lot_size || 0.01;
                    } else {
                        document.getElementById('modeScalp').checked = true;
                        document.getElementById('autoTradingOff').checked = true;
                        document.getElementById('lotSize').value = 0.01;
                    }
                }
            })();

            // Periodic signal refresh
            setInterval(updateSignalData, 3000);
        });

        // Tab switching with ARIA
        function showPage(pageId, clickedButton) {
            clickSound.play().catch(()=>{});
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');

            if (clickedButton) {
                document.querySelectorAll('.tab-button').forEach(b => { b.classList.remove('active'); b.setAttribute('aria-selected', 'false'); });
                clickedButton.classList.add('active');
                clickedButton.setAttribute('aria-selected', 'true');
            }

            document.body.classList.toggle('page2-active', pageId === 'page2');

            // Stop logs refresh & abort pending fetch when leaving page3
            if (logUpdateInterval) clearInterval(logUpdateInterval);
            if (logsAbortController) { logsAbortController.abort(); logsAbortController = null; }

            if (pageId === 'page3') {
                setupLogSelector().then(fetchAndDisplaySingleLog);
                logUpdateInterval = setInterval(fetchAndDisplaySingleLog, 5000);
            }
            if (pageId === 'page5') { setupAnalysisPage(); }
        }

        async function updateSignalData() {
            try {
                if (signalsAbortController) signalsAbortController.abort();
                signalsAbortController = new AbortController();

                const response = await fetch('/api/signals', { signal: signalsAbortController.signal });
                if (!response.ok) return;

                const allSignals = await response.json();
                const data = (allSignals && allSignals.length > 0) ? allSignals[allSignals.length - 1] : null;
                if (data) {
                    const price = parseFloat(data.price);
                    const tp = parseFloat(data.tp);
                    const sl = parseFloat(data.sl);
                    document.getElementById('signalSymbol').textContent = data.symbol || 'N/A';
                    document.getElementById('signalTimeframe').textContent = data.timeframe || 'N/A';
                    document.getElementById('currentPrice').textContent = Number.isFinite(price) ? price.toFixed(3) : 'N/A';
                    document.getElementById('signalDesc').textContent = data.desc || (currentLang === 'en' ? 'No description' : 'èª¬æ˜ãªã—');

                    const signalTypeElem = document.getElementById('signalType');
                    const sig = (data.signal || 'NONE').toUpperCase();
                    signalTypeElem.textContent = sig;
                    signalTypeElem.classList.toggle('buy', data.signal && data.signal.toLowerCase() === 'buy');
                    signalTypeElem.classList.toggle('sell', data.signal && data.signal.toLowerCase() === 'sell');

                    document.getElementById('signalEntry').textContent = Number.isFinite(price) ? price.toFixed(3) : 'N/A';
                    document.getElementById('signalTP').textContent = Number.isFinite(tp) ? tp.toFixed(3) : 'N/A';
                    document.getElementById('signalSL').textContent = Number.isFinite(sl) ? sl.toFixed(3) : 'N/A';

                    setImageSrc(document.getElementById('signalChart'), data.image_url);
                }
            } catch (error) {
                if (error.name !== 'AbortError') console.error("Failed to fetch signal data:", error);
            }
        }

        async function setupLogSelector() {
            const selectElement = document.getElementById('logSymbolSelect');
            if (selectElement.options.length > 0) return;
            try {
                const response = await fetch('/api/symbols');
                const symbols = await response.json();
                symbols.forEach(symbol => {
                    const option = document.createElement('option');
                    option.value = symbol; option.textContent = symbol;
                    selectElement.appendChild(option);
                });
                selectElement.addEventListener('change', fetchAndDisplaySingleLog);
                if (symbols.length > 0) { fetchAndDisplaySingleLog(); }
            } catch (error) { console.error('Failed to setup log selector:', error); }
        }

        async function fetchAndDisplaySingleLog() {
            const symbol = document.getElementById('logSymbolSelect').value;
            if (!symbol) return;
            const logContentElement = document.getElementById('singleLogContent');

            try {
                if (logsAbortController) logsAbortController.abort();
                logsAbortController = new AbortController();

                const response = await fetch(`/api/logs/${encodeURIComponent(symbol)}`, { signal: logsAbortController.signal });
                if (!response.ok) return;
                const logs = await response.json();

                // XSS-safe rendering
                logContentElement.innerHTML = '';
                const frag = document.createDocumentFragment();
                for (const log of logs) {
                    const div = document.createElement('div');
                    const ts = `[${log.timestamp || 'N/A'}] `;
                    const msg = (log.message || '');
                    div.append(document.createTextNode(ts + msg));
                    frag.appendChild(div);
                }
                logContentElement.appendChild(frag);
                logContentElement.scrollTop = logContentElement.scrollHeight;
            } catch (error) {
                if (error.name !== 'AbortError') console.error(`Failed to fetch logs for ${symbol}:`, error);
            }
        }

        async function setupAnalysisPage() {
            const selectElement = document.getElementById('analysisSymbol');
            if (selectElement.options.length > 0) return;
            try {
                const response = await fetch('/api/symbols');
                const symbols = await response.json();
                symbols.forEach(symbol => {
                    const option = document.createElement('option');
                    option.value = symbol; option.textContent = symbol;
                    selectElement.appendChild(option);
                });
            } catch (error) { console.error('Failed to setup analysis selector:', error); }
            document.getElementById('runAnalysisBtn').addEventListener('click', runManualAnalysis);
        }

        async function runManualAnalysis() {
            const statusElem = document.getElementById('analysisStatus');
            const predictionsElem = document.getElementById('analysisResultPredictions');
            const chartElem = document.getElementById('analysisResultChart');
            const button = document.getElementById('runAnalysisBtn');

            statusElem.textContent = currentLang === 'en' ? 'Running analysis...' : 'åˆ†æã‚’å®Ÿè¡Œä¸­...';
            button.disabled = true;

            const payload = {
                symbol: document.getElementById('analysisSymbol').value,
                timeframe: document.getElementById('analysisTimeframe').value
            };

            try {
                if (analysisAbortController) analysisAbortController.abort();
                analysisAbortController = new AbortController();

                const response = await fetch('/api/run_analysis', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload),
                    signal: analysisAbortController.signal
                });
                if (!response.ok) throw new Error(`Server error: ${response.statusText}`);
                const data = await response.json();

                if (data.status === 'success') {
                    statusElem.textContent = currentLang === 'en' ? 'Analysis completed.' : 'åˆ†æãŒå®Œäº†ã—ã¾ã—ãŸã€‚';
                    const predictionHeader = currentLang === 'en'
                        ? `--- Future Scenarios (${payload.symbol} ${payload.timeframe}) ---\n* Current Price: ${data.current_price}\n--------------------------------------------------\n`
                        : `--- æœªæ¥äºˆæ¸¬ã‚·ãƒŠãƒªã‚ª (${payload.symbol} ${payload.timeframe}) ---\n* ç¾åœ¨ä¾¡æ ¼: ${data.current_price}\n--------------------------------------------------\n`;
                    const lines = Array.isArray(data.predictions) ? data.predictions : [];
                    predictionsElem.textContent = predictionHeader + lines.map(p => `- ${p}`).join('\n');

                    setImageSrc(chartElem, data.image_url);
                    chartElem.style.display = 'block';
                } else {
                    statusElem.textContent = (currentLang === 'en'
                        ? `Analysis failed: ${data.message}`
                        : `åˆ†æã«å¤±æ•—ã—ã¾ã—ãŸ: ${data.message}`);
                }
            } catch (error) {
                if (error.name !== 'AbortError') {
                    console.error('Analysis failed:', error);
                    statusElem.textContent = (currentLang === 'en'
                        ? 'Error occurred during analysis.'
                        : 'åˆ†æä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
                }
            } finally {
                button.disabled = false;
            }
        }
    </script>

    <!-- Service Worker registration -->
    <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        // å¯èƒ½ãªã‚‰ãƒ«ãƒ¼ãƒˆç›´ä¸‹ã« /sw.js ã‚’ç½®ã„ã¦ scope ã‚’ '/' ã«ã™ã‚‹ã®ãŒç†æƒ³ã€‚
        // é™çš„é…ä¿¡ã®ã¾ã¾ã§ã‚‚ä»¥ä¸‹ã§å‹•ä½œã—ã¾ã™:
        navigator.serviceWorker.register('/static/sw.js', { scope: '/' })
          .then(reg => console.log('[SW] registered:', reg.scope))
          .catch(err => console.warn('[SW] registration failed:', err));
      });
    }
    </script>
</body>
</html>
